<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self'; img-src https://*; child-src 'none';"
        />
        <title>마커 생성하기</title>
        <!-- <script src="./index.css"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <div id="map" style="width: 100%; height: 800px"></div>

        <script
            type="text/javascript"
            src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=711e5e7f7409081cc7ca0b3f9e3b0d82"
        ></script>
        <script>
            let arr = [];
            function closeOverlay(idx) {
                console.log(idx);
                arr[idx].setMap(null);
            }
            // 커스텀 오버레이를 닫기 위해 호출되는 함수입니다

            const kakaoMap = (x, y, dataArray) => {
                var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                    mapOption = {
                        center: new kakao.maps.LatLng(x, y), // 지도의 중심좌표
                        level: 3 // 지도의 확대 레벨
                    };

                var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

                console.log(dataArray.data.length);
                // 마커가 표시될 위치입니다
                for (let i = 0; i < dataArray.data.length; i++) {
                    const data = dataArray.data[i];
                    var content =
                        '<div class="wrap">' +
                        '    <div class="info">' +
                        '        <div class="title">' +
                        '            카카오 스페이스닷원' +
                        `            <div class="close" onclick="closeOverlay(${i})" title="닫기"></div>` +
                        '        </div>' +
                        '        <div class="body">' +
                        '            <div class="img">' +
                        `                <img src="${data.imgUrl}" width="73" height="70">` +
                        '           </div>' +
                        '            <div class="desc">' +
                        '                <div class="ellipsis">제주특별자치도 제주시 첨단로 242</div>' +
                        '                <div><a href="https://www.kakaocorp.com/main" target="_blank" class="link">홈페이지</a></div>' +
                        '            </div>' +
                        '        </div>' +
                        '    </div>' +
                        '</div>';
                    // 지도에 마커를 표시합니다
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(data.x, data.y)
                    });
                    // 마커 위에 커스텀오버레이를 표시합니다
                    // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
                    var overlay = new kakao.maps.CustomOverlay({
                        content: content,
                        map: map,
                        position: marker.getPosition()
                    });
                    arr.push(overlay);
                    // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
                    kakao.maps.event.addListener(marker, 'click', function () {
                        arr[i].setMap(map);
                    });
                }

                // 이동할 위도 경도 위치를 생성합니다
                var moveLatLon = new kakao.maps.LatLng(x, y);

                // 지도 중심을 이동 시킵니다
                map.setCenter(moveLatLon);
            };

            const findXY = async () => {
                try {
                    let geolocation = navigator.geolocation;
                    var geo_options = {
                        enableHighAccuracy: true, // 불리언
                        maximumAge: 30000, // 천분의 1초 단위
                        timeout: 27000 // 천분의 1초 단위
                    };

                    geolocation.getCurrentPosition(
                        //position에 현재 사용자의 위치값이 들어감.
                        (postion) => {
                            latitude = postion.coords.latitude; //위도
                            longitude = postion.coords.longitude; //경도
                            distance = 7.0;
                            axios({
                                method: 'POST',
                                url: 'http://localhost:4000/api/map',
                                data: {
                                    latitude,
                                    longitude,
                                    distance
                                }
                            }).then((dataArray) => {
                                kakaoMap(latitude, longitude, dataArray);
                            });
                        },
                        (err) => {},
                        geo_options
                    );
                } catch (err) {
                    console.log('에러!', err);
                }
            };
            findXY();
        </script>
    </body>
</html>
